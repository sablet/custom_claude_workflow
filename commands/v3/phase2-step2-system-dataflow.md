---
allowed-tools: ["Read", "Write", "Edit", "Bash"]
description: "システム全体のデータフロー設計とMermaidダイアグラム記述"
---

# Phase2-Step2: システム全体データフロー設計

## 共通指示の参照
/v3:common-instructions

## 概要
プロジェクト全体のデータアーキテクチャを設計し、システム全体でのデータの流れを定義します。データベースのテーブル、プロパティ、データ加工ロジック、および最終的な出力スキーマ間の関係性を**Mermaidダイアグラム**で視覚化します。

## 実行手順

### 1. 前ステップの成果物を確認
* Phase2-Step1（データ構造）

### 2. 基本的な初期手順
共通指示に従い、日時取得とディレクトリ準備を実行してください。

### 3. 不足情報の特定と質問
前ステップの成果物を確認し、システム全体データフロー設計に必要な情報を質問してください：

**確認すべき項目:**
- データソース間の関係性は明確ですか？
- 主要なデータ変換・集約処理はありますか？
- データの流れとライフサイクルは明確ですか？
- 外部システムとのデータ連携はありますか？
- データアクセスパターンや頻度はどうですか？

### 4. 対話的情報収集
以下のようにシステム全体データフロー設計に必要な情報を質問してください：

```
システム全体データフロー設計のため、まず最初の項目について詳しく教えてください：

## データソースと関係性
- 主要なデータソースは何ですか？
- データ間の依存関係はどうなっていますか？

（回答を確認後、次の項目について質問を続ける）

## データ変換・加工処理
- どのようなデータ集約や計算が必要ですか？
- リアルタイム処理とバッチ処理の区分はありますか？

（回答を確認後、次の項目について質問を続ける）

## データアクセスパターン
- 高頻度でアクセスされるデータは何ですか？
- データの更新頻度はどうですか？

（回答を確認後、次の項目について質問を続ける）

## 外部連携
- 外部システムとのデータ交換はありますか？
- データ同期の要件はありますか？
```

### 5. システムデータフロー設計案の提示と承認
収集した情報を基に、以下の形式で設計案を提示してください：

```
以下のシステム全体データフロー設計でPhase2-Step2のドキュメントを作成します。内容をご確認ください：

## データアーキテクチャ概要
[システム全体のデータ構造と流れ]

## 主要データフロー
[Mermaid記法でのシステム全体フロー図]

## データ変換・加工ロジック
[集約処理、計算処理の詳細]

## 外部システム連携
[データ交換インターフェース]

## パフォーマンス考慮事項
[アクセスパターンとボトルネック分析]

この内容で問題ありませんか？修正や追加が必要な箇所があれば教えてください。
```

## Mermaidダイアグラム記述指針

### システムプロンプト
あなたは、データパイプラインをMermaid記法のダイアグラムで視覚化する専門家です。
ユーザーからの要件に基づき、データベースのテーブル、そのプロパティ、データ加工ロジック、そして最終的なAPI出力スキーマの要素間の関係性を明確に表現するダイアグラムを生成してください。

以下の制約とルールを厳守してください。

1. **データベースソースの明示的な記述の省略**: データベースがソースであることは自明であるため、ダイアグラム内に「Database」のような直接的な記述はしないでください。

2. **サブグラフの利用**:
   * **テーブル**: 各データベーステーブルは、独立した`subgraph`として表現してください。サブグラフ名はテーブル名としてください（例: `subgraph users [users テーブル]`）。
   * **テーブル以外の論理グループ**: API出力スキーマや中間処理ロジックなど、テーブル以外の概念的なグループも`subgraph`として表現してください。適切なサブグラフ名を付けてください（例: `subgraph API_Output [API Output Schema]`、`subgraph Processing_Logic [中間処理ロジック]`）。

3. **ノードの表現**:
   * **プロパティ**: 各テーブルのプロパティは、`テーブル名_プロパティ名(プロパティ名)`の形式でノードとして表現してください（例: `users_id(id)`）。
   * **加工ロジック**: 中間処理ロジック内の個々の加工ステップもノードとして表現してください（例: `calc_total_amount(計算: 合計金額)`）。

4. **データの流れ**: データは矢印 `-->` で、その流れと方向を明確に示してください。

5. **色分けのルール**:
   * **サブグラフ**:
     * **テーブルのサブグラフ**: 明るい水色 (`fill:#e0f7fa,stroke:#00acc1,stroke-width:2px`) で表現してください。
     * **API出力スキーマのサブグラフ**: 薄い緑色 (`fill:#e8f5e9,stroke:#4caf50,stroke-width:2px`) で表現してください。
     * **その他の論理グループ（例: 中間処理ロジック）**: 薄い紫色 (`fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px`) で表現してください。
   * **ノード（フィールド）**:
     * **参照されるフィールド**: データパイプラインのどこかで利用されるフィールド（結合キー、加工元、直接出力など）は、濃い青色 (`fill:#e3f2fd,stroke:#2196f3,stroke-width:2px`) で表現してください。
     * **参照されないフィールド**: テーブル内に存在するが、現在のパイプラインで利用されていないフィールドは、薄い灰色 (`fill:#f5f5f5,stroke:#bdbdbd,stroke-width:1px`) で表現してください。
     * **中間処理ノード**: 中間処理ロジック内のノードは、中間処理サブグラフの色を継承しつつ少し濃いめの紫色 (`fill:#f3e5f5,stroke:#ab47bc,stroke-width:2px`) で表現してください。
     * **API出力フィールド**: 最終的なAPI出力スキーマの各要素は、API出力スキーマのサブグラフの色を継承しつつ少し濃いめの緑色 (`fill:#e8f5e9,stroke:#66bb6a,stroke-width:2px`) で表現してください。

6. **加工の説明**: 加工が伴う場合は、Mermaidのコメント `%%` を使用して、どのような加工が行われるかを簡潔に説明してください。可能であれば、点線 `stroke-dasharray: 5 5` などを用いて視覚的に加工を表すことも検討してください。

7. **キーの明示**: 結合キーやデータ変換の元となるフィールドは、矢印のラベルやコメントで「結合キー」や「加工元」などと明示的に記述することを検討してください。

### 6. フィードバック反映とドキュメント作成
共通指示で定義されたファイル出力パス構造に従い、最終的に承認された内容でドキュメントを作成してください。

## 依存関係
- **依存元**: Phase2-Step1（データ構造定義）
- **依存先**: Phase2-Step3（API設計）、Phase3（実装準備フェーズ）

## 出力成果物
共通指示で定義されたパス構造に従って成果物を出力してください。

## 重要な対話ポイント
- システム全体のデータフローが複雑な場合は、段階的に詳細化するアプローチを取ってください
- データボトルネックやパフォーマンス影響を早期に識別してください
- 将来の拡張性を考慮したアーキテクチャ設計を心がけてください
- Mermaidダイアグラムは視覚的にわかりやすく、実装に直結する詳細度を保ってください