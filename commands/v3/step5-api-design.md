---
allowed-tools: ["Read", "Write", "Edit", "Bash"]
description: "API設計とデータフローの定義"
---

# Step5: API設計とデータフローの定義

## 概要
ユーザー要件に基づき、各APIがどのようにデータを処理し、データベースとの間でどのようにやり取りするかを**APIごとのフローチャート**で表現します。データベースのテーブル、プロパティ、データ加工ロジック、および最終的なAPI出力スキーマ間の関係性を明確にします。

## 実行手順

### 1. 前ステップの成果物を確認
@docs/step3-user-interaction.md
@docs/step4-data-structure.md

### 2. 現在の日時を取得
!date "+%Y%m%d-%H%M%S"

### 3. 不足情報の特定と質問
前ステップの成果物を確認し、API設計とデータフロー定義に必要な情報を質問してください：

**確認すべき項目:**
- 各エンドポイントの具体的な仕様は明確ですか？
- 認証・許可の要件はありますか？
- エラーハンドリングの方針はありますか？
- APIのバージョニング戦略はありますか？
- パフォーマンスやセキュリティ要件はありますか？

### 4. 対話的情報収集
以下のようにAPI設計に必要な情報を質問してください：

```
API設計とデータフロー定義のため、以下について詳しく教えてください：

1. APIエンドポイントの詳細
   - 各ユーザーストーリーに必要なAPIは何ですか？
   - 各APIの入力パラメータと出力データは何ですか？
   - どのHTTPメソッドを使いますか？

2. データ処理の流れ
   - 各APIでどのようなビジネスロジックが必要ですか？
   - データベースとのやり取りはどうなりますか？

3. セキュリティ要件
   - 認証が必要なAPIはどれですか？
   - アクセス制限や権限管理は必要ですか？

4. 非機能要件
   - レスポンス時間やスループットの要件はありますか？
   - エラー時の動作やメッセージの希望はありますか？
```

### 5. API設計案の提示と承認
収集した情報を基に、以下の形式でAPI設計案を提示してください：

```
以下のAPI設計でStep5のドキュメントを作成します。内容をご確認ください：

## APIエンドポイント一覧
[エンドポイント、HTTPメソッド、機能の一覧]

## OpenAPI仕様
[OpenAPI 3.0形式の仕様書]

## データフロー図
### [エンドポイント1]のフロー
[Mermaid記法でのフローチャート]

### [エンドポイント2]のフロー
[Mermaid記法でのフローチャート]

## セキュリティ設計
[認証・許可の仕組み]

## エラーハンドリング
[エラーコードとメッセージの定義]

この内容で問題ありませんか？修正や追加が必要な箇所があれば教えてください。
```

以下の要素を含めて設計してください：

**API設計要素:**
- **エンドポイント設計**: RESTful API の URL 構造
- **HTTPメソッド**: GET、POST、PUT、DELETE の適切な使い分け
- **リクエスト/レスポンス形式**: JSON スキーマ定義
- **認証・認可**: セキュリティ要件の実装方式
- **エラーハンドリング**: 標準的なHTTPステータスコードとエラーメッセージ

**データフロー設計要素:**
1. **入力データ検証**: リクエストパラメータのバリデーション
2. **ビジネスロジック**: データ変換・計算・加工処理
3. **データベースアクセス**: CRUD操作の詳細
4. **レスポンス生成**: 出力データの整形

**各APIエンドポイントに対して:**
- **フローチャート**: データの流れを可視化
- **シーケンス図**: コンポーネント間の相互作用
- **データ変換マッピング**: 入力→処理→出力の詳細
- **パフォーマンス考慮**: キャッシュ、ページネーション等

### 4. OpenAPI仕様書の作成
API設計はOpenAPI 3.0形式で文書化し、以下を含めてください：
- **パス定義**: 各エンドポイントの詳細
- **スキーマ定義**: リクエスト/レスポンスのデータ構造
- **認証設定**: セキュリティスキーム
- **サンプルデータ**: 具体的な入出力例

### 5. Mermaid記法でのフロー図作成
データフローとAPI相互作用図はMermaid記法で作成してください。

### 6. フィードバック反映とドキュメント作成
!mkdir -p docs

最終的に承認された内容で `docs/step5-api-design.md` を作成してください。

## 依存関係
- **依存元**: Step3（ユーザーインタラクション）、Step4（データ構造）
- **依存先**: Step6（テスト計画）、Step7（実装設計）

## 出力成果物
- `docs/step5-api-design.md`: API設計書とデータフロー設計書（OpenAPI仕様、フローチャート含む）

## 重要な対話ポイント
- APIの命名やURL構造が曖昧な場合は、他のサービスのAPIを例に出して具体化してください
- セキュリティ要件の重要度を確認し、ユーザーのリスク許容度に合わせた設計を行ってください
- パフォーマンス要件は具体的な数値（レスポンス時間、同時接続数等）で確認してください
- エラーメッセージはユーザーにとってわかりやすい表現で設計してください