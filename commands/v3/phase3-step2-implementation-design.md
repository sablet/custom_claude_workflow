---
allowed-tools: ["Read", "Write", "Edit", "Bash"]
description: "システム内部の実装設計フローチャート作成"
---

# Step7: システム内部の実装設計

## 共通指示の参照
/v3:common-instructions

## 概要
実際のコードレベルでの実装方法を、**実装の関係性を記したフローチャート**（例：クラス図、関数呼び出しシーケンス）で示します。これにより、各コンポーネントの役割、連携方法、および全体のアーキテクチャが明確になります。

## 実行手順

### 1. 前ステップの成果物を確認
* Phase2-Step1（データ構造）
* Phase2-Step2（システムデータフロー）
* Phase2-Step3（API設計）
* phase3-step1

### 2. 基本的な初期手順
共通指示に従い、日時取得とディレクトリ準備を実行してください。

### 3. 不足情報の特定と質問
前ステップの成果物を確認し、実装設計に必要な情報を質問してください：

**確認すべき項目:**
- 技術スタックやアーキテクチャの制約はありますか？
- 開発チームのスキルレベルや経験はどうですか？
- コード品質や保守性の要件はありますか？
- デプロイや運用の制約はありますか？
- サードパーティライブラリやフレームワークの選定ポリシーはありますか？

### 4. 対話的情報収集
以下のように実装設計に必要な情報を質問してください：

```
システム内部の実装設計のため、以下について詳しく教えてください：

1. 技術的制約と選定
   - 使用したいプログラミング言語やフレームワークはありますか？
   - データベースやインフラの制約はありますか？
   - 禁止されている技術やライブラリはありますか？

2. アーキテクチャの希望
   - モノリシックかマイクロサービスか、どちらを希望しますか？
   - レイヤードアーキテクチャの希望はありますか？
   - 設計パターンの好みや制約はありますか？

3. 品質と保守性
   - コードレビューや静的解析の要件はありますか？
   - ドキュメント化やコメントのルールはありますか？
   - 将来の機能拡張や修正のしやすさをどの程度重視しますか？

4. パフォーマンスとスケーラビリティ
   - パフォーマンスの目標値や制約はありますか？
   - 将来のユーザー数やデータ量の増加をどの程度考慮しますか？

5. セキュリティ実装
   - セキュリティの重要度やコンプライアンス要件はありますか？
   - ログや監視の要件はありますか？
```

### 5. 実装設計案の提示と承認
収集した情報を基に、以下の形式で実装設計案を提示してください：

```
以下の実装設計でStep7のドキュメントを作成します。内容をご確認ください：

## 技術スタック
[選定した言語、フレームワーク、ツール]

## アーキテクチャ設計
### システム全体構成
[Mermaid記法でのアーキテクチャ図]

### レイヤー構成
[プレゼンテーション層、ビジネス層、データアクセス層]

## クラス設計
[Mermaid記法でのクラス図]

## 実装フロー
### 主要機能の実装シーケンス
[Mermaid記法でのシーケンス図]

## 品質保証
[テスタビリティ設計、コード品質管理]

## セキュリティ実装
[認証・許可、データ保護、監視]

## パフォーマンス考慮
[最適化戦略、キャッシュ、スケーラビリティ]

この内容で問題ありませんか？修正や追加が必要な箇所があれば教えてください。
```

以下の要素を含めて設計してください：

**アーキテクチャ設計:**
- **レイヤード設計**: プレゼンテーション層、ビジネス層、データアクセス層
- **コンポーネント構成**: 各層内の主要コンポーネント
- **依存関係**: コンポーネント間の依存方向と結合度
- **設計パターン**: 適用する設計パターン（MVC、DI、Factory等）

**詳細設計要素:**

#### クラス設計
- **エンティティクラス**: データモデルに対応
- **サービスクラス**: ビジネスロジック実装
- **リポジトリクラス**: データアクセス抽象化
- **コントローラークラス**: API エンドポイント処理

#### 関数・メソッド設計
- **責務分離**: 単一責任原則の適用
- **入出力仕様**: 引数・戻り値の型定義
- **エラーハンドリング**: 例外処理戦略
- **ログ出力**: 監視・デバッグのためのログ設計

#### データフロー実装
- **処理シーケンス**: 各API呼び出しでの処理順序
- **データ変換**: DTOパターンによるデータマッピング
- **バリデーション**: 入力値検証の実装箇所
- **トランザクション**: データ整合性保証の仕組み

### 4. 品質保証の組み込み
Step6のテスト計画を実装に組み込むための設計：

**テスタビリティ設計:**
- **依存性注入**: モック・スタブによるテスト容易性
- **インターフェース設計**: テスト境界の明確化
- **設定外部化**: テスト環境での動作制御

**コード品質:**
- **静的解析**: リンター・フォーマッターの適用
- **型安全性**: 型システムの活用
- **ドキュメント生成**: 自動ドキュメント化の仕組み

### 5. パフォーマンス考慮
- **キャッシュ戦略**: メモリ・分散キャッシュの活用
- **データベース最適化**: インデックス、クエリ最適化
- **非同期処理**: 重い処理の非同期化
- **リソース管理**: メモリ・接続プールの管理

### 6. セキュリティ実装
- **認証・認可**: JWT、OAuth等の実装方式
- **入力サニタイズ**: SQLインジェクション、XSS対策
- **暗号化**: 機密データの保護
- **監査ログ**: セキュリティイベントの記録

### 7. フローチャート・クラス図の作成
以下をMermaid記法で作成：
- **システム全体アーキテクチャ図**
- **クラス関係図**
- **シーケンス図（実装レベル）**
- **データフロー図（実装詳細）**

### 6. フィードバック反映とドキュメント作成
共通指示で定義されたファイル出力パス構造に従い、最終的に承認された内容でドキュメントを作成してください。

## 依存関係
- **依存元**: Phase2（システム設計フェーズ）、Phase3-Step1（テスト計画）
- **依存先**: なし（実装フェーズへ）

## 出力成果物
共通指示で定義されたパス構造に従って成果物を出力してください。

## 重要な対話ポイント
- 技術選定の理由やメリット・デメリットを確認し、ユーザーの納得を得てから進めてください
- チームのスキルレベルや経験に合わない設計は避け、実装可能性を優先してください
- 過度に複雑な設計パターンやアーキテクチャは避け、シンプルさを心がけてください
- パフォーマンス最適化はボトルネックが確認されてから実施し、下手な早期最適化は避けてください