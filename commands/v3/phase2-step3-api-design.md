---
allowed-tools: ["Read", "Write", "Edit", "Bash"]
description: "API設計とデータフローの定義"
---

# Phase2-Step3: API設計（個別API）

## 共通指示の参照
/v3:common-instructions

## 概要
システム全体データフローを基に、個別のAPIエンドポイントを設計します。各APIがどのようにデータを処理し、データベースとの間でどのようにやり取りするかを**APIごとのフローチャート**で表現します。個別APIの詳細な入出力仕様とビジネスロジックを定義します。

## 実行手順

### 1. 前ステップの成果物を確認
* Phase1-Step3（ユーザーインタラクション）
* Phase2-Step1（データ構造）
* Phase2-Step2（システムデータフロー）

### 2. 基本的な初期手順
共通指示に従い、日時取得とディレクトリ準備を実行してください。

### 3. 不足情報の特定と質問
前ステップの成果物を確認し、API設計とデータフロー定義に必要な情報を質問してください：

**確認すべき項目:**
- 各エンドポイントの具体的な仕様は明確ですか？
- 認証・許可の要件はありますか？
- エラーハンドリングの方針はありますか？
- APIのバージョニング戦略はありますか？
- パフォーマンスやセキュリティ要件はありますか？

### 4. 対話的情報収集
以下のようにAPI設計に必要な情報を質問してください：

```
API設計とデータフロー定義のため、以下について詳しく教えてください：

1. APIエンドポイントの詳細
   - 各ユーザーストーリーに必要なAPIは何ですか？
   - 各APIの入力パラメータと出力データは何ですか？
   - どのHTTPメソッドを使いますか？

2. データ処理の流れ
   - 各APIでどのようなビジネスロジックが必要ですか？
   - データベースとのやり取りはどうなりますか？

3. セキュリティ要件
   - 認証が必要なAPIはどれですか？
   - アクセス制限や権限管理は必要ですか？

4. 非機能要件
   - レスポンス時間やスループットの要件はありますか？
   - エラー時の動作やメッセージの希望はありますか？
```

### 5. API設計案の提示と承認
収集した情報を基に、以下の形式でAPI設計案を提示してください：

```
以下のAPI設計でStep5のドキュメントを作成します。内容をご確認ください：

## APIエンドポイント一覧
[エンドポイント、HTTPメソッド、機能の一覧]

## OpenAPI仕様
[OpenAPI 3.0形式の仕様書]

## データフロー図
### [エンドポイント1]のフロー
[Mermaid記法でのフローチャート]

### [エンドポイント2]のフロー
[Mermaid記法でのフローチャート]

## セキュリティ設計
[認証・許可の仕組み]

## エラーハンドリング
[エラーコードとメッセージの定義]

この内容で問題ありませんか？修正や追加が必要な箇所があれば教えてください。
```

以下の要素を含めて設計してください：

**API設計要素:**
- **エンドポイント設計**: RESTful API の URL 構造
- **HTTPメソッド**: GET、POST、PUT、DELETE の適切な使い分け
- **リクエスト/レスポンス形式**: JSON スキーマ定義
- **認証・認可**: セキュリティ要件の実装方式
- **エラーハンドリング**: 標準的なHTTPステータスコードとエラーメッセージ

**データフロー設計要素:**
1. **入力データ検証**: リクエストパラメータのバリデーション
2. **ビジネスロジック**: データ変換・計算・加工処理
3. **データベースアクセス**: CRUD操作の詳細
4. **レスポンス生成**: 出力データの整形

**各APIエンドポイントに対して:**
- **フローチャート**: データの流れを可視化
- **シーケンス図**: コンポーネント間の相互作用
- **データ変換マッピング**: 入力→処理→出力の詳細
- **パフォーマンス考慮**: キャッシュ、ページネーション等

### 4. OpenAPI仕様書の作成
API設計はOpenAPI 3.0形式で文書化し、以下を含めてください：
- **パス定義**: 各エンドポイントの詳細
- **スキーマ定義**: リクエスト/レスポンスのデータ構造
- **認証設定**: セキュリティスキーム
- **サンプルデータ**: 具体的な入出力例

### 5. Mermaid記法でのフロー図作成
データフローとAPI相互作用図はMermaid記法で作成してください。

#### Mermaidダイアグラム記述のためのシステムプロンプト

```
あなたは、データパイプラインをMermaid記法のダイアグラムで視覚化する専門家です。
ユーザーからの要件に基づき、データベースのテーブル、そのプロパティ、データ加工ロジック、そして最終的なAPI出力スキーマの要素間の関係性を明確に表現するダイアグラムを生成してください。

以下の制約とルールを厳守してください。

1.  **データベースソースの明示的な記述の省略**: データベースがソースであることは自明であるため、ダイアグラム内に「Database」のような直接的な記述はしないでください。
2.  **サブグラフの利用**:
    * **テーブル**: 各データベーステーブルは、独立した`subgraph`として表現してください。サブグラフ名はテーブル名としてください（例: `subgraph users [users テーブル]`）。
    * **テーブル以外の論理グループ**: API出力スキーマや中間処理ロジックなど、テーブル以外の概念的なグループも`subgraph`として表現してください。適切なサブグラフ名を付けてください（例: `subgraph API_Output [API Output Schema]`、`subgraph Processing_Logic [中間処理ロジック]`）。
3.  **ノードの表現**:
    * **プロパティ**: 各テーブルのプロパティは、`テーブル名_プロパティ名(プロパティ名)`の形式でノードとして表現してください（例: `users_id(id)`）。
    * **加工ロジック**: 中間処理ロジック内の個々の加工ステップもノードとして表現してください（例: `calc_total_amount(計算: 合計金額)`）。
4.  **データの流れ**: データは矢印 `-->` で、その流れと方向を明確に示してください。
5.  **色分けのルール**:
    * **サブグラフ**:
        * **テーブルのサブグラフ**: 明るい水色 (`fill:#e0f7fa,stroke:#00acc1,stroke-width:2px`) で表現してください。
        * **API出力スキーマのサブグラフ**: 薄い緑色 (`fill:#e8f5e9,stroke:#4caf50,stroke-width:2px`) で表現してください。
        * **その他の論理グループ（例: 中間処理ロジック）**: 薄い紫色 (`fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px`) で表現してください。
    * **ノード（フィールド）**:
        * **参照されるフィールド**: データパイプラインのどこかで利用されるフィールド（結合キー、加工元、直接出力など）は、濃い青色 (`fill:#e3f2fd,stroke:#2196f3,stroke-width:2px`) で表現してください。
        * **参照されないフィールド**: テーブル内に存在するが、現在のパイプラインで利用されていないフィールドは、薄い灰色 (`fill:#f5f5f5,stroke:#bdbdbd,stroke-width:1px`) で表現してください。
        * **中間処理ノード**: 中間処理ロジック内のノードは、中間処理サブグラフの色を継承しつつ少し濃いめの紫色 (`fill:#f3e5f5,stroke:#ab47bc,stroke-width:2px`) で表現してください。
        * **API出力フィールド**: 最終的なAPI出力スキーマの各要素は、API出力スキーマのサブグラフの色を継承しつつ少し濃いめの緑色 (`fill:#e8f5e9,stroke:#66bb6a,stroke-width:2px`) で表現してください。
6.  **加工の説明**: 加工が伴う場合は、Mermaidのコメント `%%` を使用して、どのような加工が行われるかを簡潔に説明してください。可能であれば、点線 `stroke-dasharray: 5 5` などを用いて視覚的に加工を表すことも検討してください。
7.  **キーの明示**: 結合キーやデータ変換の元となるフィールドは、矢印のラベルやコメントで「結合キー」や「加工元」などと明示的に記述することを検討してください。

ユーザーが提供するデータパイプラインの要件を詳細に分析し、上記ルールに従って正確なMermaidダイアグラムを生成してください。
```

### 6. フィードバック反映とドキュメント作成
共通指示で定義されたファイル出力パス構造に従い、最終的に承認された内容でドキュメントを作成してください。

## 依存関係
- **依存元**: Phase1-Step3（ユーザーインタラクション）、Phase2-Step1（データ構造）、Phase2-Step2（システム全体データフロー）
- **依存先**: Phase3-Step1（テスト計画）、Phase3-Step2（実装設計）

## 出力成果物
共通指示で定義されたパス構造に従って成果物を出力してください。

## 重要な対話ポイント
- APIの命名やURL構造が曖昧な場合は、他のサービスのAPIを例に出して具体化してください
- セキュリティ要件の重要度を確認し、ユーザーのリスク許容度に合わせた設計を行ってください
- パフォーマンス要件は具体的な数値（レスポンス時間、同時接続数等）で確認してください
- エラーメッセージはユーザーにとってわかりやすい表現で設計してください